<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="JVM-Class-02-字节码指令集与解析举例, SaddyFire">
    <meta name="description" content="字节码指令集与解析举例">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>JVM-Class-02-字节码指令集与解析举例 | SaddyFire</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/loading.css">
<meta name="generator" content="Hexo 7.1.0"><link rel="alternate" href="/atom.xml" title="SaddyFire" type="application/atom+xml">
</head>


<body>
    
    <div id="loading-box">
        <div class="loading-left-bg"></div>
        <div class="loading-right-bg"></div>
        <div class="spinner-box">
            <div class="configure-border-1">
                <div class="configure-core"></div>
            </div>
            <div class="configure-border-2">
                <div class="configure-core"></div>
            </div>
            <div class="loading-word">玩命加载中🤣🤣🤣</div>
        </div>
    </div>
    <!-- 页面加载动画 -->
    <script>
        $(document).ready(function () {
            document.body.style.overflow = 'auto';
            document.getElementById('loading-box').classList.add("loaded")
        })
    </script>


    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">SaddyFire</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">SaddyFire</div>
        <div class="logo-desc">
            
            每一个抖腿的人, 心里都有台缝纫机
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/images/article/46.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">JVM-Class-02-字节码指令集与解析举例</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/JVM/">
                                <span class="chip bg-color">JVM</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/program/" class="post-category">
                                program
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-01-05
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-01-06
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    42 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>字节码指令集与解析举例</h1>
<h2 id="01-概述">01-概述</h2>
<ul>
<li>Java 字节码对于虚拟机，就好像汇编语言对于计算机，属于基本执行指令。</li>
<li>Java 虚拟机的指令由<strong>一个字节长度</strong>的、代表着某种特定操作含义的数字（称为操作码，Opcode)以及跟随其后的零至多个代表此操作所需参数（称为操作数，Operands)而构成。由于Java虚拟机采用面向操作数栈而不是寄存器的结构，所以大多数的指令都不包含操作数，只有一个操作码。</li>
<li>由于限制了 Java 虚拟机操作码的长度为一个字节（即0~255），这意味着指令集的操作码总数不可能超过 256 条。</li>
<li>官方文档：https:/docs.oracle.com/javase./specs/jvms/se8/html/jvms-6.html</li>
<li>熟悉虚拟机的指令对于动态字节码生成、反编译 Class 文件、Class文件修补都有着非常重要的价值。因此，阅读字节码作为了解 Java 虚拟机的基础技能，需要熟练掌握常见指令。</li>
</ul>
<p><strong>执行模型</strong></p>
<p>如果不考虑异常处理的话，那么Java虚拟机的解释器可以使用下面这个伪代码当做最基本的执行模型来理解</p>
<pre class="line-numbers language-null" data-language="null"><code class="language-null">do&#123;
    自动计算PC寄存器的值加1;
    根据PC寄存器的指示位置，从字节码流中取出操作码;
    if(字节码存在操作数)从字节码流中取出操作数;
    执行操作码所定义的操作;
&#125; while (字节码长度 &gt; 0);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>字节码于数据类型</strong></p>
<p>在 Java 虚拟机的指令集中，大多数的指令都包含了其操作所对应的数据类型信息。例如，iload 指令用于从局部变量表中加载 int 型的数据到操作数栈中，而 fload 指令加载的则是 float 类型的数据。</p>
<p>对于大部分与数据类型相关的字节码指令，<strong>它们的操作码助记符中都有特殊的字符来表明专门为哪种数据类型服务</strong>：</p>
<ul>
<li>i 代表对 int类型的数据操作，</li>
<li>l 代表 long</li>
<li>s代表 short</li>
<li>b 代表 byte</li>
<li>c 代表 char</li>
<li>f 代表 float</li>
<li>d 代表 double</li>
</ul>
<p>也有一些指令的助记符中没有明确地指明操作类型的字母，如 arraylength 指令，它没有代表数据类型的特殊字符，但操作数永远只能是一个数组类型的对象。</p>
<p>还有另外一些指令，如无条件跳转指令 goto 则是与<strong>数据类型无关的</strong>。</p>
<p>大部分的指令都没有支持整数类型 byte、char 和 short，甚至没有任何指令支持boolean类型。编译器会在编译期或运行期将 byte 和 short 类型的数据带符号扩展 (Sign-Extend) 为相应的 int 类型数据，将 boolean 和 char 类型数据零位扩展 (Zero-Extend) 为相应的 int 类型数据。与之类似，在处理 boolean、byte、short 和 char 类型的数组时，也会转换为使用对应的 int 类型的字节码指令来处理。因此，大多数对于 boolean、byte、short 和 char 类型数据的操作，实际上都是使用相应的 int 类型作为运算类型。</p>
<h3 id="指令分类">指令分类</h3>
<ul>
<li>由于完全介绍和学习这些指令需要花费大量时间。为了让大家能更快地熟悉和了解这些基本指令，这里将JVM中的字节码指令集按用途大致分成9类。
<ul>
<li>加载与存储指令</li>
<li>算术指令</li>
<li>类型转换指令</li>
<li>对象的创建与访问指令</li>
<li>方法调用与返回指令</li>
<li>操作数栈管理指令</li>
<li>比较控制指令</li>
<li>异常处理指令</li>
<li>同步控制指令</li>
</ul>
</li>
<li>(说在前面) 在做值相关操作时：
<ul>
<li>一个指令，可以从局部变量表、常量池、堆中对象、方法调用、系统调用中等取得数据，这些数据（可能是值，可能是对象的引用)被压入操作数栈。</li>
<li>一个指令，也可以从操作数栈中取出一到多个值( pop 多次)，完成赋值、加减乘除、方法传参、系统调用等等操作。</li>
</ul>
</li>
</ul>
<h2 id="02-加载与存储指令">02-加载与存储指令</h2>
<p><strong>作用</strong></p>
<p>加载和存储指令用于将数据从栈帧的局部变量表和操作数栈之间来回传递。</p>
<p><strong>常用指令</strong></p>
<pre class="line-numbers language-null" data-language="null"><code class="language-null">1、【局变量压栈指令】将一个局部变量加载到操作数栈：x1oad、x1oad&lt;n&gt;(其中x为i、l、f、d、a，n 为 0 到 3)
------------------------------------------------------------------------------
2、【常量入栈指令】将一个常量加载到操作数栈：bipush、sipush、ldc、ldc_w、ldc2_w、aconst_nul1、iconst_ml、iconst&lt;i&gt;、lconst_&lt;l&gt;、fconst_&lt;f&gt;、dconst&lt;d&gt;
-------------------------------------------------------------------------------
3、【出栈装入局部变量表指令】将一个数值从操作数栈存储到局部变量表：xstore、xstore_&lt;n&gt;（其中 x 为 i、1、f、d、a，n 为 g 到3)；xastore(其中 x 为 i、l、f、d、a、b、c、s)
--------------------------------------------------------------------------------
4、扩充局部变量表的访问索引的指令：wide。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面所列举的指令助记符中，有一部分是以尖括号结尾的（例如 <code>iload_&lt;n&gt;</code> )。这些指令助记符实际上代表了一组指令(例如 <code>iload&lt;n&gt;</code> 代表了 <code>iload_0</code> 、<code>iload_1</code>、<code>iload_2</code> 和 <code>iload_3</code> 这几个指令)。这几组指令都是某个带有一个操作数的通用指令（例如 <code>iload</code> )的特殊形式，<strong>对于这若干组特殊指令来说，它们表面上没有操作数，不需要进行取操作数的动作，但操作数都隐含在指令中。</strong></p>
<blockquote>
<p>比如:</p>
<p>iload_0: 将局部变量表中索引为0位置上的数据压入操作数栈中。</p>
<p>iload 0: 与上条一样。</p>
<p>iload 4: 将局部变量表中索引为4位置上的数据压入操作数栈中。</p>
</blockquote>
<p>除此之外，它们的语义与原生的通用指令完全一致（例如 <code>iload_0</code> 的语义与操作数为0时的 <code>iload</code> 指令语义完全一致)。在尖括号之间的字母指定了指令隐含操作数的数据类型，<code>&lt;n&gt;</code> 代表非负的整数，<code>&lt;i&gt;</code> 代表是 int 类型数据，<code>&lt;l&gt;</code> 代表 long 类型，<code>&lt;f&gt;</code>代表 float 类型， <code>&lt;d&gt;</code> 代表double类型。操作byte, char, short 和 boolean 类型数据时, 经常用 int 类型的指令来表示。</p>
<h3 id="复习-再谈操作数栈与局部变量表">复习: 再谈操作数栈与局部变量表</h3>
<p><strong>操作数栈(Operand Stacks)</strong></p>
<ul>
<li>我们知道，Java 字节码是 Java 虚拟机所使用的指令集。因此，它与 Java 虚拟机基于栈的计算模型是密不可分的。</li>
<li>在解释执行过程中，每当为 Java 方法分配栈桢时，Java 虚拟机往往需要开辟一块额外的空间作为<strong>操作数栈，来存放计算的操作数以及返回结果。</strong></li>
<li>具体来说便是：执行每一条指令之前，Java 虚拟机要求该指令的操作数已被压入操作数栈中。在执行指令时，Java 虚拟机会将该指令所需的操作数弹出，并且将指令的结果重新压入栈中。</li>
</ul>
<p><img src="./../jvm-class2/image-20240106092421015.png" alt=""></p>
<blockquote>
<p>以加法指令 iadd 为例:</p>
<p>假设在执行该指令前, 栈顶的两个元素分别为 int 值 1 和 int 值 2, 那么 iadd 指令将弹出这两个 int, 并将求得的和 int 值 3 压入栈中</p>
</blockquote>
<p><img src="./../jvm-class2/image-20240106092608805.png" alt=""></p>
<blockquote>
<p>由于iadd 指令只消耗栈顶的两个元素，因此，对于离栈顶距离为2的元素，即图中的问号，iadd指令并不关心它是否存在，更加不会对其进行修改。</p>
</blockquote>
<p><strong>局部变量表(Local Variables)</strong></p>
<ul>
<li>Java方法栈桢的另外一个重要组成部分则是局部变量区，<strong>字节码程序可以将计算的结果缓存在局部变量区之中</strong>。</li>
<li>实际上，Java虚拟机将局部变量区<strong>当成一个数组</strong>，依次存放 this 指针（仅非静态方法），所传入的参数，以及字节码中的局部变量。</li>
<li>和操作数栈一样，long类型以及double类型的值将占据两个单元，其余类型仅占据一个单元。</li>
</ul>
<img src="./../jvm-class2/image-20240106093239190.png" style="zoom:67%;" />
<p>举例:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">long</span> l<span class="token punctuation">,</span> <span class="token keyword">float</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">"hello, world"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106093419431.png" alt="对应图示"></p>
<blockquote>
<p>在栈帧中，与性能调优关系最为密切的部分就是局部变量表。局部变量表中的变量也是重要的垃圾回收根节点，只要被局部变量表中直接或间接引用的对象都不会被回收。</p>
<p>在方法执行时，虚拟机使用局部变量表完成方法的传递。</p>
</blockquote>
<h3 id="1-局部变量压栈指令">1-局部变量压栈指令</h3>
<ul>
<li>
<p>局部变量压栈指令将给定的局部变量表中的数据压入操作数栈。</p>
</li>
<li>
<p>这类指令大体可以分为：</p>
</li>
</ul>
<blockquote>
<p><code>xload_&lt;n&gt;</code> (x 为 i、l、f、d、a，n 为 0 到 3)<br>
<code>xload</code> (x 为 i、l、f、d、a)</p>
</blockquote>
<blockquote>
<p>说明：在这里，x 的取值表示数据类型。</p>
<p>指令 <code>xload_n</code> 表示将第 n 个局部变量压入操作数栈，比如 <code>iload_1</code>、<code>fload_0</code>、<code>aload_0</code> 等指令。其中<code>aload_n</code> 表示将一个对象引用压栈。<br>
指令 <code>xload</code> 通过指定参数的形式，把局部变量压入操作数栈，当使用这个命令时，表示局部变量的数量可能超过了4个，比如指令iload、f1oad等。</p>
</blockquote>
<p><strong>代码示例:</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 局部变量压入栈</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">long</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flag<span class="token punctuation">,</span> <span class="token keyword">short</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106095818409.png" alt=""></p>
<h3 id="2-常量入栈指令">2-常量入栈指令</h3>
<p>常量入栈指令的功能是将常数压入操作数栈，根据数据类型和入栈内容的不同，又可以分为cost系列、push系列和ldc指令。</p>
<ul>
<li>指令 const 系列：
<ul>
<li>用于对特定的常量入栈，入栈的常量隐含在指令本身里。指令有：<code>iconst_&lt;i&gt;</code> (i 从 -1 到 5)、<code>lconst_&lt;1&gt;</code> (1从0到1)、<code>fconst_&lt;f&gt;</code> (f 从 0 到 2)、<code>dconst_&lt;d&gt;</code>(d 从 0 到 1)、<code>aconst_null</code>。</li>
<li>比如:<br>
<code>iconst_m1</code> 将 -1 压入操作数栈;<br>
<code>iconst_×</code> (x 为 0 到 5)将 x 压入栈;<br>
<code>lconst_0</code>、<code>lconst_1</code> 分别将长整数 0 和 1 压入栈;<br>
<code>fconst_0</code>、<code>fconst_1</code>、<code>fconst_2</code> 分别将浮点数 0、1、2压入栈;<br>
<code>dconst_0</code> 和 <code>dconst_1</code> 分别将 double 型 0 和 1 压入栈;<br>
<code>aconst_null</code> 将<code>null</code> 压入操作数栈;</li>
<li>从指令的命名上不难找出规律，指令助记符的第一个字符总是喜欢表示数据类型，i 表示整数，l 表示长整数，f 表示浮点数，d表示双精度浮点，习惯上用 a 表示对象引用。如果指令隐含操作的参数，会以下划线形式给出。</li>
</ul>
</li>
<li>指令 push 系列:
<ul>
<li>主要包括 bipush 和 sipush 。它们的区别在于接收数据类型的不同，bipush 接收 8 位整数作为参数，sipush 接收 16 位整数，它们都将参数压入栈。</li>
</ul>
</li>
<li>指令 ldc 系列:
<ul>
<li>如果以上指令都不能满足需求，那么可以使用万能的 ldc 指令，它可以接收一个 8 位的参数，该参数指向常量池中的 int、float 或者 String 的索引，将指定的内容压入堆栈。</li>
<li>类似的还有 <code>ldc_w</code> , 它接收两个 8 位参数, 能支持的索引范围大于 ldc。</li>
<li>如果要压入的元素是 long 或者 double 类型的, 则使用 <code>ldc2_w</code> 指令, 使用方式都是类似的。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-null" data-language="null"><code class="language-null">举例
int i &#x3D; 3;	const_3
int j &#x3D; 6;	bipush 6
int k &#x3D; 32768 ldc 索引<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>类型</th>
<th>常数指令</th>
<th>范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>int (boolean, byte, char, short)</td>
<td>iconst</td>
<td>[-1, 5]</td>
</tr>
<tr>
<td></td>
<td>bipush</td>
<td>[-128, 127]</td>
</tr>
<tr>
<td></td>
<td>sipush</td>
<td>[-32768, 32767]</td>
</tr>
<tr>
<td></td>
<td>ldc</td>
<td>any int value</td>
</tr>
<tr>
<td>long</td>
<td>lconst</td>
<td>0, 1</td>
</tr>
<tr>
<td></td>
<td>ldc</td>
<td>any long value</td>
</tr>
<tr>
<td>float</td>
<td>fconst</td>
<td>0, 1, 2</td>
</tr>
<tr>
<td></td>
<td>ldc</td>
<td>any float value</td>
</tr>
<tr>
<td>double</td>
<td>dconst</td>
<td>0, 1</td>
</tr>
<tr>
<td></td>
<td>ldc</td>
<td>any double value</td>
</tr>
<tr>
<td>reference</td>
<td>aconst</td>
<td>null</td>
</tr>
<tr>
<td></td>
<td>ldc</td>
<td>String literal, Class literal</td>
</tr>
</tbody>
</table>
<p><strong>代码示例:</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushCounstLdc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> d <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> e <span class="token operator">=</span> <span class="token number">12344567</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106102527127.png" alt=""></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">constLdc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> a1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> a2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> b1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> b2 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> c1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> c2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token class-name">Date</span> d <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106103251827.png" alt=""></p>
<blockquote>
<p>注意：常量入栈指令中的 n 和局部变量压栈指令中的 n 不一样，本次的 n 代表数值或者对象，而不是局部变量表中的下标</p>
</blockquote>
<h3 id="3-出栈装入局部变量表指令">3-出栈装入局部变量表指令</h3>
<p>出栈装入局部变量表指令用于将操作数栈中栈顶元素弹出后，装入局部变量表的指定位置，用于给局部变量赋值</p>
<p>这类指令主要以 store 的形式存在，比如 <code>xstore</code> (x 为 i、l、f、d、a)、<code>xstore_n</code>(x 为 i、l、f、d、a，n 为 0 至 3)。</p>
<ul>
<li>其中，指令 <code>istore_n</code> 将从操作数栈中弹出一个整数，并把它赋值给局部变量索引 n 位置。</li>
<li>指令<code>xstore</code> 由于没有隐含参数信息，故需要提供一个 byte 类型的参数类指定目标局部变量表的位置。</li>
</ul>
<p><strong>说明:</strong></p>
<ul>
<li>
<p>**一般说来，类似像stor这样的命令需要带一个参数，用来指明将弹出的元素放在局部变量表的第几个位置。**但是，为了尽可能压缩指令大小，使用专门的 <code>istore_1</code> 指令表示将弹出的元素放置在局部变量表第 1 个位置。类似的还有 <code>istore_0</code>、<code>istore_2</code>、<code>istore_3</code>，它们分别表示从操作数栈顶弹出一个元素，存放在局部变量表第0、2、3个位置。</p>
</li>
<li>
<p>由于局部变量表前几个位置总是非常常用，因此<strong>这种做法虽然增加了指令数量，但是可以大大压缩生成的字节码的体积</strong>。</p>
</li>
<li>
<p>如果局部变量表很大，需要存储的槽位大于3，那么可以使用 istore 指令，外加一个参数，用来表示需要存放的槽位位置。</p>
</li>
</ul>
<p><strong>代码示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//3.出栈装入局部变量表指令</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">double</span> d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> m <span class="token operator">=</span> k <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"dee"</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token number">10.0F</span><span class="token punctuation">;</span>
    d <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106105001697.png" alt=""></p>
<p><img src="./../jvm-class2/image-20240106105603987.png" alt="槽位复用"></p>
<h2 id="03-算数指令">03-算数指令</h2>
<p><strong>1、作用：</strong></p>
<p>算术指令用于对两个操作数栈上的值进行某种特定运算，并把结果重新压入操作数栈。<br>
<strong>2、分类：</strong></p>
<p>大体上算术指令可以分为两种：对<strong>整型数据</strong>进行运算的指令与对<strong>浮点类型数据</strong>进行运算的指令。<br>
<strong>3、byte、short、char和boolean:类型说明</strong></p>
<p>在每一大类中，都有针对Java虚拟机具体数据类型的专用算术指令。但没有直接支持byte、short、char 和 boolean 类型的算术指令，对于这些数据的运算，都使用 int 类型的指令来处理。此外，在处理boolean、byte、short 和 char 类型的数组时，也会转换为使用对应的 int 类型的字节码指令来处理。</p>
<p><strong>Java虚拟机中的实际类型与运算类型</strong></p>
<table>
<thead>
<tr>
<th>实际类型</th>
<th>运算类型</th>
<th>分类</th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean</td>
<td>int</td>
<td>一</td>
</tr>
<tr>
<td>byte</td>
<td>int</td>
<td>一</td>
</tr>
<tr>
<td>char</td>
<td>int</td>
<td>一</td>
</tr>
<tr>
<td>short</td>
<td>int</td>
<td>一</td>
</tr>
<tr>
<td>int</td>
<td>int</td>
<td>一</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
<td>一</td>
</tr>
<tr>
<td>reference</td>
<td>reference</td>
<td>一</td>
</tr>
<tr>
<td>returnAddress</td>
<td>returnAddress</td>
<td>一</td>
</tr>
<tr>
<td>long</td>
<td>long</td>
<td>二</td>
</tr>
<tr>
<td>double</td>
<td>double</td>
<td>二</td>
</tr>
</tbody>
</table>
<p><strong>4、运算时的溢出</strong></p>
<p>数据运算可能会导致溢出，例如两个很大的正整数相加，结果可能是一个负数。其实 Java 虚拟机规范并无明确规定过整型数据溢出的具体结果，仅规定了在处理整型数据时，只有除法指令以及求余指令中当出现除数为 0 时会导致虚拟机抛出异常 ArithmeticException。<br>
<strong>5、运算模式</strong></p>
<ul>
<li>向最接近数舍入模式：JVM 要求在进行浮点数计算时，所有的运算结果都必须舍入到适当的精度，非精确结果必须舍入为可被表示的最接近的精确值，如果有两种可表示的形式与该值一样接近，将优先选择最低有效位为零的;</li>
<li>向零舍入模式：将浮点数转换为整数时，采用该模式，该模式将在目标数值类型中选择一个最接近但是不大于原值的数字作为最精确的舍入结果;</li>
</ul>
<p><strong>6、NaN值使用</strong><br>
当一个操作产生溢出时，将会使用有符号的无穷大表示，如果某个操作结果没有明确的数学定义的话，将会使用 NaN 值来表示。而且所有使用 NaN 值作为操作数的算术操作，结果都会返回NaN;</p>
<p><img src="./../jvm-class2/image-20240106112039355.png" alt=""></p>
<h3 id="所有算术指令">所有算术指令</h3>
<pre class="line-numbers language-null" data-language="null"><code class="language-null">加法指令: iadd、ladd、fadd、dadd
减法指令: isub、lsub、fsub、dsub
乘法指令: imul、lmul、fmul、dmul
除法指令: idiv、ldiv、fdiv、ddiv
求余指令: irem、lrem、frem、drem	&#x2F;&#x2F;remainder: 余数
取反指令: ineg、lneg、fneg、dnge	&#x2F;&#x2F;negation: 取反
自增指令: iinc	&#x2F;&#x2F;注意: iinc 1 by 1 是指对局部变量表slot[1]的数据自增, 不是操作数栈
位运算指令, 又可分为:
	- 位移指令: ishl、ishr、iushr、lshl、lshr、lushr
	- 按位或指令: ior、lor
	- 按位与指令: iand、land
	- 按位异或指令: ixor、lxor
比较指令: dcmpg、dcmpl、fcmpg、fcmpl、lcmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>代码举例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> j <span class="token operator">=</span> <span class="token operator">-</span>i<span class="token punctuation">;</span>
    i <span class="token operator">=</span> <span class="token operator">-</span>j<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
    i <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">method4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">*</span> c<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">method5</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106114334466.png" alt=""></p>
<p>👍**++运算符**</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>i<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method7</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> i<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token operator">++</span>j<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106120727259.png" alt=""></p>
<h3 id="比较指令的说明">比较指令的说明</h3>
<ul>
<li>比较指令的作用是比较栈顶两个元素的大小，并将比较结果入栈。</li>
<li>比较指令有：<code>dcmpg</code>、<code>dcmpl</code>、<code>fcmpg</code>、<code>fcmpl</code>、<code>lcmp</code>。
<ul>
<li>与前面讲解的指令类似，首字符d表示double类型，f 表示 float , l 表示 long。</li>
</ul>
</li>
<li>对于 double 和 float 类型的数字，由于 NaN 的存在，各有两个版本的比较指令。以 float 为例，有 <code>fcmpg</code> 和 <code>fcmpl</code> 两个指令，它们的区别在于在数字比较时，若遇到NaN值，处理结果不同。</li>
<li>指令 <code>dcmpl</code> 和 <code>dcmpg</code> 也是类似的，根据其命名可以推测其含义，在此不再赘述。</li>
<li>指令 <code>lcmp</code> 针对 long 型整数，由于 long 型整数没有 NaN 值，故无需准备两套指令。</li>
</ul>
<p><strong>举例：</strong><br>
指令 <code>fcmpg</code> 和 fcmpl 都从栈中弹出两个操作数，并将它们做比较，设栈顶的元素为 v2，栈顶顺位第2位的元素为 v1(v2在上, v1在下)</p>
<ul>
<li>若 <code>v1 = v2</code>，则压入 0;</li>
<li>若 <code>v1 &gt; v2</code> 则压入 1；</li>
<li>若 <code>v1 &lt; v2</code> 则压入-1。<br>
两个指令的不同之处在于，如果遇到 NaN 值，<code>fcmpg</code> 会压入 1，而 <code>Fcmpl</code> 会压入 -1。</li>
</ul>
<blockquote>
<p>数值类型的数据，才以谈大小！(byte\short\char\int; long\float\double)<br>
boolean、引用数据类型不能比较大小。</p>
<p>注意：NaN(Not a Number) 表示不是一个数字，比如 0.0/0.0 得到的可能是1.0（两个数相等），也可能是0.0（0.0是分子），也可能是无穷大（0.0是分母），所以老师给出的解释是 NaN 代表无法确定是什么数字，只有 double 和 float 类型中可能出现 NaN 的情况，而 long 类型不会出现 NaN ，所以只有 lcmp ，而没有 lcml</p>
</blockquote>
<h2 id="04-类型转换指令">04-类型转换指令</h2>
<p><strong>类型转换指令说明</strong></p>
<ol>
<li>类型转换指令可以将两种不同的数值类型进行相互转换。</li>
<li>这些转换操作一般用于实现用户代码中的显式类型转换操作，或者用来处理字节码指令集中数据类型相关指令无法与数据类型一一对应的问题。</li>
</ol>
<h3 id="1-宽化类型转换">1-宽化类型转换</h3>
<p><strong>宽化类型转换(Widening Numeric Conversions)</strong></p>
<p><strong>1、转换规则：</strong><br>
Java虚拟机直接支持以下数值的宽化类型转换(widening numeric conversion, 小范围类型向大范围类型的安全转换)。也就是说，并不需要指令执行，包括：</p>
<ul>
<li>从 int 类型到 long、float 或者 double 类型。对应的指令为：i2l、i2f、i2d</li>
<li>从 long 类型到float、double类型。对应的指令为：12f、12d</li>
<li>从 float 类型到 double 类型。对应的指令为：f2d</li>
</ul>
<blockquote>
<p>简化为：int --&gt; long --&gt; float --&gt; double</p>
</blockquote>
<p><strong>2、精度损失问题</strong></p>
<ol>
<li>
<p>宽化类型转换是不会因为超过目标类型最大值而丢失信息的，例如，从 int 转换到long, 或者从 int 转换到 double , 都不会丢失任何信息，转换前后的值是精确相等的。</p>
</li>
<li>
<p>从int、long 类型数值转换到 float , 或者 long 类型数值转换到 double 时，将可能发生精度丢失——可能丢失掉几个最低有效位上的值，转换后的浮点数值是根据 IEEE754 最接近舍入模式所得到的正确整数值。</p>
<p>尽管宽化类型转换实际上是可能发生精度丢失的，但是这种转换永远不会导致 Java 虚拟机抛出运行时异常。</p>
</li>
</ol>
<p><strong>3、补充说明</strong></p>
<ul>
<li>
<p><strong>从 byte、char 和 short 类型到 int 类型的宽化类型转换实际上是不存在</strong>的。对于 byte 类型转为 int, 虚拟机并没有做实质性的转化处理，只是简单地通过操作数栈交换了两个数据。而将 byte 转为 long 时，使用的是 i2l , 可以看到在内部 byte 在这里已经等同于 int 类型处理，类似的还有 short 类型，这种处理方式有两个特点：</p>
</li>
<li>
<p>一方面可以减少实际的数据类型，如果为 short 和 byte 都准备一套指令，那么指令的数量就会大增，<strong>而虚拟机目前的设计上，只愿意使用一个字节表示指令，因此指令总数不能超过256个，为了节省指令资源，将 short 和 byte 当做 int 处理也在情理之中。</strong></p>
</li>
<li>
<p>另一方面，由于局部变量表中的槽位固定为32位，无论是 byte 或者 short 存入局部变量表，都会占用32位空间。从这个角度说，也没有必要特意区分这几种数据类型。</p>
</li>
</ul>
<p><strong>代码示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 针对于宽化类型转换的基本测试</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upCast1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">double</span> d <span class="token operator">=</span> i<span class="token punctuation">;</span>

    <span class="token keyword">float</span> f1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> d1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> d2 <span class="token operator">=</span> f1<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 精度损失案例</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upCast2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">111222333</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1.23123120 出现精度丢失</span>

    <span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token number">111222333444555666L</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> d <span class="token operator">=</span> l<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1.11222333444555664E17</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// byte, char, short类型到int类型的宽化类型转换实际上是不存在的</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cpCast3</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token keyword">double</span> d <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upCast4</span><span class="token punctuation">(</span><span class="token keyword">short</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106133833047.png" alt=""></p>
<h3 id="2-窄化类型转换">2-窄化类型转换</h3>
<p><strong>窄化类型转换(Narrowing Numeric Conversion)</strong><br>
<strong>1、转换规则</strong><br>
Java虚拟机也直接支持以下窄化类型转换:</p>
<ul>
<li>从 int 类型至 byte, short 或者 char 类型. 对应的指令有：i2b、i2c、i2s</li>
<li>从 long 类型到 int 类型. 对应的指令有：l2i</li>
<li>从 float 类型到 int 或者 long 类型。对应的指令有：f2i、f2l</li>
<li>从 double 类型到 int、long 或者 float 类型。对应的指令有：d2i、d2l、d2f</li>
</ul>
<p><strong>2、精度损失问题</strong></p>
<p>窄化类型转换可能会导致转换结果具备不同的正负号、不同的数量级，因此，转换过程很可能会导致数值丢失精度</p>
<p>尽管数据类型窄化转换可能会发生上限溢出、下限溢出和精度丢失等情况，但是Java虚拟机规范中明确规定数值类型的窄化转换指令水远不可能导致虚拟机抛出运行时异常</p>
<blockquote>
<p>注意：从float、double、long等类型往byte、short、char类型转换的时候，需要先把前面几种类型转换成int类型，然后在从int类型转换到后面这几种类型，所以int类型相等于一种过渡类型</p>
</blockquote>
<p><strong>3、补充说明</strong></p>
<ul>
<li>
<p>当将一个浮点值窄化转换为整数类型 T (T 限于 int 或 long 类型之一)的时候，将遵循以下转换规则：</p>
<ul>
<li>如果浮点值是 NaN, 那转换结果就是 int 或 long 类型的 0</li>
<li>如果浮点值不是无穷大的话，浮点值使用 IEEE 754 的向零舍入模式取整，获得整数值 v ,如果 v 在目标类型 T(int 或 long) 的表示范围之内，那转换结果就是v。否则，将根据 v 的符号，转换为 T 所能表示的最大或者最小正数</li>
</ul>
</li>
<li>
<p>当将一个 double 类型窄化转换为 float 类型时，将遵循以下转换规则：</p>
<p>通过向最接近数舍入模式舍入一个可以使用 float 类型表示的数字。最后结果根据下面这3条规则判断：</p>
<ul>
<li>如果转换结果的绝对值太小而无法使用 float 来表示，将返回 float 类型的正负零。</li>
<li>如果转换结果的绝对值太大而无法使用 float 来表示，将返回 float 类型的正负无穷大。</li>
<li>对于 double 类型的 NaN 值将按规定转换为 float 类型的 NaN 值。</li>
</ul>
</li>
</ul>
<p><strong>代码示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">downCast5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">double</span> d1 <span class="token operator">=</span> <span class="token class-name">Double<span class="token punctuation">.</span>NaN</span><span class="token punctuation">;</span> <span class="token comment">//0.0 / 0.0</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> d1<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//NaN</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//0</span>

    <span class="token keyword">double</span> d2 <span class="token operator">=</span>  <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token constant">POSITIVE_INFINITY</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> d2<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> d2<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//9223372036854775807</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//9223372036854775807</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//2147483647</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//2147483647</span>

    <span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> d1<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//NaN</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="05-对象的创建于访问指令">05-对象的创建于访问指令</h2>
<p>Java是面向对象的程序设计语言，虚拟机平台从字节码层面就对面向对象做了深层次的支持。有一系列指令专门用于对象操作，可进一步细分为创建指令、字段访问指令、数组操作指令、类型检查指令。</p>
<h3 id="1-创建指令">1-创建指令</h3>
<p>虽然类实例和数组都是对象，但]ava虚拟机对类实例和数组的创建与操作使用了不同的字节码指令：</p>
<ol>
<li>创建类实例的指令：
<ul>
<li>创建类实例的指令：<code>new</code>
<ul>
<li>它接收一个操作数，为指向常量池的索引，表示要创建的类型，执行完成后，将对象的引用压入栈。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src="./../jvm-class2/image-20240106142557664.png" alt="new的字节码指令"></p>
<ol start="2">
<li>创建数组的指令：
<ul>
<li>创建数组的指令：<code>newarray</code>、<code>anewarray</code>、<code>multianewarray</code>
<ul>
<li><code>newarray</code>: 创建基本类型数组</li>
<li><code>anewarray</code>: 创建引用类型数组</li>
<li><code>multianewarray</code>: 创建多维数组</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src="./../jvm-class2/image-20240106143336444.png" alt="new arr"></p>
<p><img src="./../jvm-class2/image-20240106143421808.png" alt="new multianewarray"></p>
<p>上述创建指令可以用于创建对象或者数组，由于对象和数组在 Java 中的广泛使用，这些指令的使用频率也非常高。</p>
<h3 id="2-字段访问指令">2-字段访问指令</h3>
<p>对象创建后，就可以通过对象访问指令获取对象实例或数组实例中的字段或者数组元素。</p>
<ul>
<li>访问类字段(static 字段，或者称为类变量)的指令：
<ul>
<li><code>getstatic</code>: 将当前用 static 修饰的字段压入操作数栈中</li>
<li><code>putstatic</code>: 将数据弹栈</li>
</ul>
</li>
<li>访问类实例字段（非 static 字段，或者称为实例变量）的指令：
<ul>
<li><code>getfield</code>: 压栈</li>
<li><code>putfield</code>: 弹栈</li>
</ul>
</li>
</ul>
<p><strong>举例：</strong><br>
以 <code>getstatic</code> 指令为例，它含有一个操作数，为指向常量池的 <code>Fieldref</code> 索引，它的作用就是获取 <code>Fieldref</code> 指定的<br>
对象或者值，并将其压入操作数栈。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="./../jvm-class2/image-20240106144117955.png" alt=""></p>
<p><img src="./../jvm-class2/image-20240106154017401.png" alt="稍微复杂demo"></p>
<h3 id="3-数组操作指令">3-数组操作指令</h3>
<p>数组操作指令主要有：<code>xastore</code> 和 <code>xaload</code> 指令。具体为：</p>
<ul>
<li>把一个数组元素加载到操作数栈的指令：<code>baload</code>、<code>caload</code>、<code>saload</code>、<code>iaload</code>、<code>laload</code>、<code>faload</code>、<code>daload</code>、<code>aaload</code></li>
<li>将一个操作数栈的值存储到数组元素中的指令：<code>bastore</code>、<code>castore</code>、<code>sastore</code>、 <code>iastore</code>、<code>lastore</code>、<code>fastore</code>、<code>dastore</code>、<code>aastore</code></li>
</ul>
<table>
<thead>
<tr>
<th>数组类型</th>
<th>加载指令</th>
<th>存储指令</th>
</tr>
</thead>
<tbody>
<tr>
<td>byte(boolean)</td>
<td>baload</td>
<td>bastore</td>
</tr>
<tr>
<td>char</td>
<td>caload</td>
<td>castore</td>
</tr>
<tr>
<td>short</td>
<td>saload</td>
<td>sastore</td>
</tr>
<tr>
<td>int</td>
<td>iaload</td>
<td>iastore</td>
</tr>
<tr>
<td>long</td>
<td>laload</td>
<td>lastore</td>
</tr>
<tr>
<td>float</td>
<td>faload</td>
<td>fastore</td>
</tr>
<tr>
<td>double</td>
<td>daload</td>
<td>dastore</td>
</tr>
<tr>
<td>reference</td>
<td>aaload</td>
<td>aastore</td>
</tr>
</tbody>
</table>
<ul>
<li>取数组长度的指令: <code>arraylength</code>
<ul>
<li>该指令弹出栈顶的数组元素，获取数组的长度，将长度压入栈</li>
</ul>
</li>
</ul>
<p><strong>说明</strong></p>
<ul>
<li>指令 <code>xaload</code> 表示将数组的元素压栈，比如 <code>saload</code>、<code>caload</code> 分别表示压入 <code>short</code> 数组和 <code>char</code> 数组。指令 <code>xaload</code> 在执行时，要求操作数中栈顶元素为数组索引 i ，栈顶顺位第 2 个元素为数组引用 a ，该指令会弹出栈顶这两个元素，并将 a[i] 重新压入栈。</li>
<li><code>xastore</code> 则专门针对数组操作，以 <code>iastore</code> 为例，它用于给一个 int 数组的给定索引赋值。在 <code>iastore</code> 执行前，操作数栈顶需要以此准备 3 个元素：值、索引、数组引用，<code>iastore</code> 会弹出这 3 个值，并将值赋给数组中指定索引的位置。</li>
</ul>
<p><img src="./../jvm-class2/image-20240106160141019.png" alt="数组操作指令示例"></p>
<h3 id="4-类型检查指令">4-类型检查指令</h3>
<p>检查类实例或数组类型的指令：<code>instanceof</code>、<code>checkcast</code>。</p>
<ul>
<li>指令 <code>checkcast</code> 用于检查类型强制转换是否可以进行。如果可以进行，那么 <code>checkcast</code> 指令不会改变操作数栈，否则它会抛出 ClassCastException 异常。</li>
<li>指令 <code>instanceof</code> 用来判断给定对象是否是某一个类的实例，它会将判断结果压入操作数栈。</li>
</ul>
<h2 id="06-方法调用与返回指令">06-方法调用与返回指令</h2>
<h3 id="方法调用指令">方法调用指令</h3>
<ul>
<li><code>invokevirtual</code> 指令用于调用对象的实例方法，根据对象的实际类型进行分派（虚方法分派），支持多态。这也是 Java 语言中<strong>最常见的方法分派方式</strong>。</li>
<li><code>invokeinterface</code> 指令用于<strong>调用接口方法</strong>，它会在运行时搜索由特定对象所实现的这个接口方法，并找出适合的方法进行调用。</li>
</ul>
<p><img src="./../jvm-class2/image-20240106163409683.png" alt="invokeinterface 指令"></p>
<p><img src="./../jvm-class2/image-20240106182137779.png" alt="static 情况下"></p>
<ul>
<li><code>invokespecial</code> 指令用于调用一些需要特殊处理的实例方法，包括**实例初始化方法（构造器）、私有方法和父类方法。**这些方法都是静态类型绑定的，不会在调用时进行动态派发。</li>
</ul>
<p><img src="./../jvm-class2/image-20240106162611730.png" alt="invokespecial 指令"></p>
<ul>
<li><code>invokestatic</code> 指令用于调用命名类中的<strong>类中的类方法(static方法)</strong>。这是静态绑定的。</li>
</ul>
<p><img src="./../jvm-class2/image-20240106162933197.png" alt="invokestatic 指令"></p>
<ul>
<li><code>invokedynamic</code> 调用动态绑定的方法，这个是 JDK1.7 后新加入的指令。用于在运行时动态解析出调用点限定符所引用的方法，并执行该方法。前面4条调用指令的分派逻辑都固化在 Java 虚拟机内部，而 <code>invokedynamic</code> 指令的分派逻辑是由用户所设定的引导方法决定的。</li>
</ul>
<h3 id="方法返回指令">方法返回指令</h3>
<p>方法调用结束前，需要进行返回。方法返回指令是<strong>根据返回值的类型区分</strong>的。</p>
<ul>
<li>包括 <code>ireturn</code> (当返回值是boolean、byte、char、short 和 int 类型时使用)、lreturn、freturn、dreturn 和 areturn</li>
<li>另外还有一条return指令供声明为void的方法、实例初始化方法以及类和接口的类初始化方法使用。</li>
</ul>
<table>
<thead>
<tr>
<th>返回类型</th>
<th>返回指令</th>
</tr>
</thead>
<tbody>
<tr>
<td>void</td>
<td>return</td>
</tr>
<tr>
<td>int (boolean, byte, char, short)</td>
<td>ireturn</td>
</tr>
<tr>
<td>long</td>
<td>lreturn</td>
</tr>
<tr>
<td>float</td>
<td>freturn</td>
</tr>
<tr>
<td>double</td>
<td>dreturn</td>
</tr>
<tr>
<td>reference</td>
<td>areturn</td>
</tr>
</tbody>
</table>
<p><strong>举例：</strong></p>
<p>通过 <code>ireturn</code> 指令，将当前函数操作数栈的顶层元素弹出，并将这个元素压入调用者函数的操作数栈中（因为调用者非常关心函数的返回值)，所有在当前函数操作数栈中的其他元素都会被丢弃。</p>
<p>如果当前返回的是 synchronized 方法，那么还会执行一个隐含的 monitorexit 指令，退出临界区。</p>
<p>最后，会丢弃当前方法的整个帧，恢复调用者的帧，并将控制权转交给调用者。</p>
<h2 id="07-操作数栈管理指令">07-操作数栈管理指令</h2>
<p>如同操作一个普通数据结构中的堆栈那样，JVM 提供的操作数栈管理指令，可以用于直接操作操作数栈的指令。</p>
<p>这类指令包括如下内容：</p>
<ul>
<li>将一个或两个元素从栈顶弹出，并且直接废弃：<code>pop</code>, <code>pop2</code> ;</li>
</ul>
<p><img src="./../jvm-class2/image-20240106184820442.png" alt="pop 字节码指令"></p>
<p><img src="./../jvm-class2/image-20240106184953305.png" alt="pop2 字节码指令"></p>
<ul>
<li>复制栈顶一个或两个数值并将复制值或双份的复制值重新压入栈顶：<code>dup</code>, <code>dup2</code>, <code>dup_x1</code>, <code>dup2_x1</code>, <code>dup_x2</code>, <code>dup2_x2</code> ;</li>
</ul>
<p><img src="./../jvm-class2/image-20240106190045604.png" alt="👍dup_x2 字节码指令"></p>
<p><img src="./../jvm-class2/image-20240106191239053.png" alt="流程示例"></p>
<ul>
<li>将栈最顶端的两个 Slot 数值位置交换：<code>swap</code>。Java 虚拟机没有提供交换两个64位数据类型(long、double)数值的指令。</li>
<li>指令 <code>nop</code> ，是一个非常特殊的指令，它的字节码为 0x00。和汇编语言中的 <code>nop</code> 一样，它表示什么都不做。这条指令一般可用于调试、占位等。</li>
</ul>
<p>这些指令属于通用型，对栈的压入或者弹出无需指明数据类型。</p>
<p><strong>说明</strong></p>
<ul>
<li>不带 <code>_x</code> 的指令是复制栈顶数据并压入栈顶。包括两个指令，<code>dup</code> 和 <code>dup2</code>。<code>dup</code>的系数代表要复制的 Slot 个数。
<ul>
<li><code>dup</code> 开头的指令用于复制1个 Slot 的数据。例如1个 int 或1个 reference 类型数据</li>
<li><code>dup2</code> 开头的指令用于复制2个 Slot 的数据。例如1个 long ,或2个 int ,或1个 int+1 个 float 类型数据</li>
</ul>
</li>
<li>带 <code>_x</code> 的指令是复制栈顶数据并插入栈顶以下的某个位置。共有4个指令，<code>dup_×1</code> , <code>dup2_×1</code>, <code>dup_x2</code>, <code>dup2_x2</code>。对于带 <code>_x</code> 的复制插入指令，只要将指令的 <code>dup</code> 和 x 的系数相加，结果即为需要插入的位置。因此
<ul>
<li><code>dup_×1</code> 插入位置：1+1=2，即栈顶 2 个 Slot 下面</li>
<li><code>dup_×2</code> 插入位置：1+2=3，即栈顶 3 个 Slot 下面</li>
<li><code>dup2_×1</code> 插入位置：2+1=3，即栈顶 3 个 Slot 下面</li>
<li><code>dup2_×2</code> 插入位置：2+2=4，即栈顶 4 个 Slot 下面</li>
</ul>
</li>
<li><code>pop</code>: 将栈顶的 1 个 Slot 数值出栈。例如 1 个 short 类型数值</li>
<li><code>pop2</code>: 将栈顶的 2 个 Slot 数值出栈。例如 1 个 double 类型数值，或者 2 个 int 类型数值</li>
</ul>
<h2 id="08-控制转义指令">08-控制转义指令</h2>
<p>程序流程离不开条件控制，为了支持条件跳转，虚拟机提供了大量字节码指令，大体上可以分为:</p>
<ol>
<li>比较指令</li>
<li>条件跳转指令</li>
<li>比较条件跳转指令</li>
<li>多条件分支跳转指令</li>
<li>无条件跳转指令等</li>
</ol>
<h3 id="1-条件跳转指令">1-条件跳转指令</h3>
<p>条件跳转指令通常和比较指令结合使用。在条件跳转指令执行前，一般可以先用比较指令进行栈顶元素的准备，然后进行条件跳转。</p>
<ul>
<li>
<p>条件跳转指令有：</p>
<p><code>ifeq</code>、<code>iflt</code>、<code>ifle</code>、<code>ifne</code>、<code>ifgt</code>、<code>ifge</code>、<code>ifnull</code>、<code>ifnonnull</code>。这些指令都接收两个字节的操作数，用于计算跳转的位置(16位符号整数作为当前位置的offset)。</p>
</li>
<li>
<p>它们的统一含义为：弹出栈顶元素，测试它是否满足某一条件，如果满足条件，则跳转到给定位置。</p>
</li>
</ul>
<p><strong>具体说明</strong></p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ifeq</td>
<td>当栈顶 int 类型数值等于( == ) 0 时跳转</td>
</tr>
<tr>
<td>ifne</td>
<td>当栈顶 int 类型数值不等于( != ) 0 时跳转</td>
</tr>
<tr>
<td>iflt</td>
<td>当栈顶 int 类型数值小于( &lt; ) 0 时跳转</td>
</tr>
<tr>
<td>ifle</td>
<td>当栈顶 int 类型数值小于等于( &lt;= ) 0 时跳转</td>
</tr>
<tr>
<td>ifgt</td>
<td>当栈顶 int 类型数值大于( &gt; ) 0 时跳转</td>
</tr>
<tr>
<td>ifge</td>
<td>当栈顶 int 类型数值大于等于( &gt;= ) 0 时跳转</td>
</tr>
<tr>
<td>ifnull</td>
<td>为 null 时跳转</td>
</tr>
<tr>
<td>ifnonnull</td>
<td>不为 null 时跳转</td>
</tr>
</tbody>
</table>
<p><img src="./../jvm-class2/image-20240106200908309.png" alt="控制转移指令 字节码示例"></p>
<p><strong>注意</strong></p>
<ol>
<li>与前面运算规则一致：
<ul>
<li>对于boolean、byte、char、short 类型的条件分支比较操作，都是使用 int 类型的比较指令完成</li>
<li>对于long、float、doub1e 类型的条件分支比较操作，则会先执行相应类型的比较运算指令，运算指令会返回一个整型值到操作数栈中，随后再执行 int 类型的条件分支比较操作来完成整个分支跳转</li>
</ul>
</li>
<li>由于各类型的比较最终都会转为 int 类型的比较操作，所以 Java 虚拟机提供的 int 类型的条件分支指令是最为丰富和强大的。</li>
</ol>
<h3 id="2-比较条件跳转指令">2-比较条件跳转指令</h3>
<p>比较条件跳转指令类似于比较指令和条件跳转指令的结合体，它将比较和跳转两个步骤合二为一。</p>
<ul>
<li>
<p>这类指令有：</p>
<p><code>if_icmpeq</code>、<code>if_icmpne</code>、<code>if_icmplt</code>、<code>if_icmpgt</code>、<code>if_icmple</code>、<code>if_icmpge</code>、<code>if_acmpeq</code> 和 <code>if_acmpne</code></p>
</li>
<li>
<p>其中指令助记符加上 <code>if_</code> 后，以字符 “i” 开头的指令针对 int 型整数操作（也包括 short 和 byte 类型），以字符 “a” 开头的指令表示对象引用的比较。</p>
</li>
</ul>
<p><strong>具体说明</strong></p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>if_icmpeq</td>
<td>比较栈顶两 int 类型数值大小, 当前者等于( == )后者时跳转</td>
</tr>
<tr>
<td>if_icmpne</td>
<td>比较栈顶两 int 类型数值大小, 当前者不等于( != )后者时跳转</td>
</tr>
<tr>
<td>if_icmplt</td>
<td>比较栈顶两 int 类型数值大小, 当前者小于( &lt; )后者时跳转</td>
</tr>
<tr>
<td>if_icmple</td>
<td>比较栈顶两 int 类型数值大小, 当前者小于等于( &lt;= )后者时跳转</td>
</tr>
<tr>
<td>if_icmpgt</td>
<td>比较栈顶两 int 类型数值大小, 当前者大于( &gt; )后者时跳转</td>
</tr>
<tr>
<td>if_icmpge</td>
<td>比较栈顶两 int 类型数值大小, 当前者大于等于( &gt;= )后者时跳转</td>
</tr>
<tr>
<td>if_acmpeq</td>
<td>比较栈顶两引用类型数值, 当结果相等( == )时跳转</td>
</tr>
<tr>
<td>if_acmpne</td>
<td>比较栈顶两引用类型数值, 当结果不相等( != )时跳转</td>
</tr>
</tbody>
</table>
<p>这些指令都接收两个字节的操作数作为参数，用于计算跳转的位置。同时在执行指令时，栈顶需要准备两个元素进行比较。</p>
<p>指令执行完成后，栈顶的这两个元素被清空，且没有任何数据入栈。<strong>如果预设条件成立，则执行跳转，否则，继续执行下一条语句。</strong></p>
<p><img src="./../jvm-class2/image-20240106203044098.png" alt="比较条件跳转指令 字节码示例"></p>
<h3 id="3-多条件分支跳转">3-多条件分支跳转</h3>
<p>多条件分支跳转指令是专为 switch-case 语句设计的，主要有 <code>tableswitch</code> 和 <code>lookupswitch</code>。</p>
<table>
<thead>
<tr>
<th>指令名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>tableswitch</td>
<td>用于 switch 条件跳转, case 值连续</td>
</tr>
<tr>
<td>lookupswitch</td>
<td>用于 switch 条件跳转, case 值不连续</td>
</tr>
</tbody>
</table>
<p>从助记符上看，两者都是 switch 语句的实现，它们的区别：</p>
<ul>
<li><code>tableswitch</code> 要求<strong>多个条件分支值是连续的</strong>，它内部只存放起始值和终止值，以及若干个跳转偏移量，通过给定的操作数 index ,可以立即定位到跳转偏移量位置，因此效率比较高。</li>
<li>指令 <code>lookupswitch</code> 内部<strong>存放着各个离散的 case-offset 对</strong>，每次执行都要搜索全部的case-offset对，找到匹配的 case 值，并根据对应的 offset 计算跳转地址，因此<strong>效率较低</strong>。</li>
</ul>
<p>指令 <code>tableswitch</code> 的示意图如下图所示。由于 tableswitch 的 case 值是连续的，因此只需要记录最低值和最高值，以及每一项对应的 offset 偏移量，根据给定的 index 值通过简单的计算即可直接定位到 offset。</p>
<p><img src="./../jvm-class2/image-20240106205131253.png" alt=""></p>
<p>指令 <code>lookupswitch</code> 处理的是离散的 case 值，但是出于效率考虑，<strong>将 case-offset 对按照 case 值大小排序</strong>，给定 index 时，需要查找与 index 相等的 case，获得其 offset，如果找不到则跳转到 default。指令 <code>lookupswitch</code> 如下图所示:</p>
<p><img src="./../jvm-class2/image-20240106205707776.png" alt=""></p>
<p><img src="./../jvm-class2/image-20240106214520880.png" alt="多条件分支跳转 int类型"></p>
<p><img src="./../jvm-class2/image-20240106214843775.png" alt="多条件分支跳转 String类型"></p>
<h3 id="4-无条件跳转">4-无条件跳转</h3>
<p>目前主要的无条件跳转指令为 <code>goto</code>。指令 <code>goto</code> 接收两个字节的操作数，共同组成一个带符号的整数，<strong>用于指定指令的偏移量，指令执行的目的就是跳转到偏移量给定的位置处。</strong></p>
<p>如果指令偏移量太大，超过双字节的带符号整数的范围，则可以使用指令 <code>goto_w</code>,它和 <code>goto</code> 有相同的作用，但是它接收4个字节的操作数，可以表示更大的地址范围。</p>
<p>指令 <code>jsr</code>、<code>jsr_w</code>、<code>ret</code> 虽然也是无条件跳转的，但主要用于 try-finally 语句，且己经被虚拟机逐渐废弃，故不在这里介绍这两个指令。</p>
<table>
<thead>
<tr>
<th>指令名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>goto</td>
<td>无条件跳转</td>
</tr>
<tr>
<td>goto_w</td>
<td>无条件跳转(宽索引)</td>
</tr>
<tr>
<td>jsr</td>
<td>跳转至指定16位 offset 位置, 并将 jsr 下一条指令地址压入栈顶</td>
</tr>
<tr>
<td>jsr_w</td>
<td>跳转至指定32位 offset 位置, 并将 jsr_w 下一条指令地址压入栈顶</td>
</tr>
<tr>
<td>ret</td>
<td>返回至由指定的局部变量所给出的指令位置(一般与 jsr、jsr_w 联合使用)</td>
</tr>
</tbody>
</table>
<p><img src="./../jvm-class2/image-20240106223005785.png" alt="无条件跳转 字节码示例"></p>
<p><img src="./../jvm-class2/image-20240106223332201.png" alt="无条件跳转 字节码示例"></p>
<h2 id="09-异常处理指令">09-异常处理指令</h2>
<h3 id="1-抛出异常指令">1-抛出异常指令</h3>
<ol>
<li>
<p><code>athrow</code> 指令</p>
<p>在 Java 程序中显示抛出异常的操作(throw 语句)都是由 <code>athrow</code> 指令来实现</p>
<p>除了使用 throw 语句显示抛出异常情况之外，<strong>JVM 规范还规定了许多运行时异常会在其他Java虚拟机指令检测到异常状况时自动抛出。</strong></p>
<ul>
<li>例如，在之前介绍的整数运算时，当除数为零时，虚拟机会在 <code>idiv</code> 或 <code>ldiv</code> 指令中抛出 ArithmeticException 异常。</li>
</ul>
</li>
<li>
<p><strong>注意</strong></p>
<p>正常情况下，操作数栈的压入弹出都是一条条指令完成的。唯一的例外情况是<strong>在抛异常时，Java 虚拟机会清除操作数栈上的所有内容，而后将异常实例压入调用者操作数栈上。</strong></p>
</li>
</ol>
<blockquote>
<p>异常及异常的处理:</p>
<p>过程一: 异常对象的生成过程 —&gt; thorw(手动 / 自动) —&gt; 指令: <code>athrow</code></p>
<p>过程二: 异常的处理: 抓抛模型. try-catch-finally —&gt; 使用异常表</p>
</blockquote>
<p><img src="./../jvm-class2/image-20240106225108694.png" alt="抛出异常指令"></p>
<h3 id="2-异常处理与异常表">2-异常处理与异常表</h3>
<p><strong>1、处理异常</strong></p>
<p>在 Java 虚拟机中，处理异常(catch 语句)不是由字节码指令来实现的（早期使用jsr、ret 指令），而是<strong>采用异常表来完成的</strong>。</p>
<p><strong>2、异常表</strong></p>
<p>如果一个方法定义了一个 try-catch 或者 try-finally 的异常处理，就会创建一个异常表。它包含了每个异常处理或者 finally 块的信息。异常表保存了每个异常处理信息。比如：</p>
<ul>
<li>起始位置</li>
<li>结束位置</li>
<li>程序计数器记录的代码处理的偏移地址</li>
<li>被捕获的异常类在常量池中的索引</li>
</ul>
<p><strong>当一个异常被抛出时，JVM 会在当前的方法里寻找一个匹配的处理，如果没有找到，这个方法会强制结束并弹出当前栈帧</strong>，并且异常会重新抛给上层调用的方法（在调用方法栈帧）。如果在所有栈帧弹出前仍然没有找到合适的异常处理，这个线程将终止。如果这个异常在最后一个非守护线程里抛出，将会导致 JVM 自己终止，比如这个线程是个 main 线程。</p>
<p><strong>不管什么时候抛出异常，如果异常处理最终匹配了所有异常类型，代码就会继续执行</strong>。在这种情况下，如果方法结束后没有抛出异常，仍然执行 finally 块，在 return 前，它直接跳到 finally 块来完成目标。</p>
<p><img src="./../jvm-class2/image-20240106230756279.png" alt="异常处理 字节码示例"></p>
<p><img src="./../jvm-class2/image-20240106232311847.png" alt="思考题"></p>
<h2 id="10-同步控制指令">10-同步控制指令</h2>
<p><strong>组成</strong></p>
<p>Java 虚拟机支持两种同步结构：<strong>方法级的同步</strong>和<strong>方法内部一段指令序列的同步</strong>，这两种同步都是使用 monitor 来支持的。</p>
<h3 id="1-方法级的同步">1-方法级的同步</h3>
<p>方法级的同步：<strong>是隐式的</strong>，即无须通过字节码指令来控制，它实现在方法调用和返回操作之中。虚拟机可以从方法常量池的方法表结构中的 ACC_SYNCHRONIZED 访问标志得知一个方法是否声明为同步方法；</p>
<p>当调用方法时，调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否设置。</p>
<ul>
<li>如果设置了，执行线程将先持有同步锁，然后执行方法。最后在方法完成（无论是正常完成还是非正常完成）时<strong>释放同步锁</strong>。</li>
<li>在方法执行期间，执行线程持有了同步锁，其他任何线程都无法再获得同一个锁。</li>
<li>如果一个同步方法执行期间抛出了异常，并且在方法内部无法处理此异常，那这个同步方法所持有的锁将在异常抛到同步方法之外时自动释放。</li>
</ul>
<p><img src="./../jvm-class2/image-20240106233448740.png" alt=""></p>
<p><strong>说明：</strong><br>
这段代码和普通的无同步操作的代码没有什么不同，没有使用 monitorenter 和 monitorexit 进行同步区控制。这是因为，对于同步方法而言，<strong>当虚拟机通过方法的访问标示符判断是一个同步方法时，会自动在方法调用前进行加锁</strong>，当同步方法执行完毕后，不管方法是正常结束还是有异常抛出，均会由虚拟机释放这个锁。因此，对于同步方法而言，monitorenter 和<br>
monitorexit 指令是隐式存在的，并未直接出现在字节码中。</p>
<h3 id="2-方法内指定指令序列的同步">2-方法内指定指令序列的同步</h3>
<p>同步一段指令集序列：通常是由 Java 中的 synchronized 语句块来表示的。JVM 的指令集有 <code>monitorenter</code> 和 <code>monitorexit</code> 两条指令来支持 <code>synchronized</code> 关键字的语义。</p>
<p>当一个线程进入同步代码块时，它使用 <code>monitorenter</code> 指令请求进入。如果当前对象的监视器计数器为0，则它会被准许进入，若为1，则判断持有当前监视器的线程是否为自己，如果是，则进入，否则进行等待，直到对象的监视器计数器为0，才会被允许进入同步块。</p>
<p>当线程退出同步块时，需要使用 monitorexit 声明退出。在 Java 虚拟机中，任何对象都有一个监视器与之相关联，用来判断对象是否被锁定，当监视器被持有后，对象处于锁定状态。</p>
<p>指令 monitorenter 和 monitorexit 在执行时，都需要在操作数栈顶压入对象，之后 monitorenter 和 monitorexit 的锁定和释放都是针对这个对象的监视器进行的。</p>
<p>下图展示了监视器如何保护临界区代码不同时被多个线程访问，只有当线程4离开临界区后，线程1、2、3才有可能进入。</p>
<p><img src="./../jvm-class2/image-20240106233717918.png" alt=""></p>
<p><img src="./../jvm-class2/image-20240106234904022.png" alt="指定指令序列同步 字节码示例"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.saddyfire.cn" rel="external nofollow noreferrer">👑Dee👑</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.saddyfire.cn/2024/01/05/jvm-class2/">https://www.saddyfire.cn/2024/01/05/jvm-class2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.saddyfire.cn" target="_blank">👑Dee👑</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/JVM/">
                                    <span class="chip bg-color">JVM</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/01/06/jvm-class3/">
                    <div class="card-image">
                        
                        <img src="/images/article/47.jpg" class="responsive-img" alt="JVM-Class-03-类的加载过程详解">
                        
                        <span class="card-title">JVM-Class-03-类的加载过程详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            类的加载过程详解
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-01-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/program/" class="post-category">
                                    program
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/01/02/jvm-class1/">
                    <div class="card-image">
                        
                        <img src="/images/article/45.jpg" class="responsive-img" alt="JVM-Class-01-class文件结构">
                        
                        <span class="card-title">JVM-Class-01-class文件结构</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            class文件结构
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-01-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/program/" class="post-category">
                                    program
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: SaddyFire<br />'
            + '文章作者: 👑Dee👑<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h2, h3, h4, h5'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2023-2024</span>
            
            <a href="/about" target="_blank">👑Dee👑</a>
            
                <span id="translate">|&nbsp;繁/简：</span><a id="translateLink" href="javascript:translatePage();">繁</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2023";
                        var startMonth = "2";
                        var startDate = "3";
                        var startHour = "23";
                        var startMinute = "22";
                        var startSecond = "33";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
                <span id="icp"><img src="/medias/icp.png"
                                    style="vertical-align: text-bottom;"/>
                <a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备2022021631号-2</a>
            </span>
            
            
                &emsp;&emsp;&emsp;<span id="icp">
                <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010202002588" target="_blank">浙公网安备 33010202002588号</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/SaddyFire" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:960879984@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=960879984" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 960879984" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            // 如果用户点击切换则进行标记
            sessionStorage.setItem('manualDark','0')
            $('body').hasClass('DarkMode')
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <script>
        //自动切换夜间模式
        if (!sessionStorage.getItem('manualDark')){
            // 当前主题是否为夜间模式
            let isDark = localStorage.getItem("isDark") === '1';
            // 当前时间是否为夜间
            let isNight = (new Date().getHours() >= 20 || new Date().getHours() < 7)
            // 夜间但不是夜间模式
            if (isNight && !isDark) {
                $('body').addClass('DarkMode')
                localStorage.setItem('isDark', '1')
                $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')
            }
            // 不是夜间但是夜间模式
            if (!isNight && isDark) {
                $('body').removeClass('DarkMode')
                localStorage.setItem('isDark', '0')
                $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')
            }
        }
    </script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>


    
        <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script>
        <script>
            if (window.mermaid) {
                mermaid.initialize({theme: 'forest'});
            }
        </script>
    

    
        <script type="text/javascript" src="/js/tw_cn.js"></script>
        <script type="text/javascript">
          var defaultEncoding = 2; //网站编写字体是否繁体，1-繁体，2-简体
          var translateDelay = 0; //延迟时间,若不在前, 要设定延迟翻译时间, 如100表示100ms,默认为0
          var cookieDomain = "https://www.saddyfire.cn"; //Cookie地址, 一定要设定, 通常为你的网址
          var msgToTraditionalChinese = "繁"; //此处可以更改为你想要显示的文字
          var msgToSimplifiedChinese = "简"; //同上，但两处均不建议更改
          var translateButtonId = "translateLink"; //默认互换id
          translateInitilization();
        </script>
    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
